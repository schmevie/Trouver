<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
	<title>Meteroar!</title>
	<script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(500, 500, Phaser.AUTO, '', { preload: preload, create: create, update: update, render: render }),
    radius = 110,
    rotation = 0,
    rotationSpeed = 0.015;

function preload() {

    game.load.image('sky', 'assets/sky.png');
    game.load.image('planet', 'assets/planet.png');
    game.load.image('star', 'assets/star.png');
    game.load.spritesheet('dude', 'assets/dude.png', 32, 48);

}
var player;
var planet;
var star;
var cursors;
var meteors;



function create() {
    //Enabling the physics for the rest of the game
    game.physics.startSystem(Phaser.Physics.Arcade);
    //  A simple background for our game
    game.add.sprite(0, 0, 'sky');
    // The planet the user will rotate around
    //planet = game.add.sprite(game.world.width/4 -5, game.world.height/4 - 30, 'planet');
    planet = game.add.sprite(game.world.width/4 -5, game.world.height/4 - 5, 'planet');
    // The player and its settings
    player = game.add.sprite(game.world.centerX, game.world.centerY, 'dude');

    //Group of meteors
    meteors = game.add.group();
    meteors.enableBody = true;
    //meteors.create(100, 100, 'star');
    //game.time.events.repeat(Phaser.Timer.SECOND * 5, 1000000, createMeteor, this);

    //Enable physics
    game.physics.enable([meteors,planet, player], Phaser.Physics.ARCADE);


    //Setting the player's initial properties
    player.anchor.set(0.5);
    player.y -= 153;
    player.body.immovable = true;
    player.body.setSize(player.width/2, player.height/2);

    planet.body.immovable = true;

    //Animations for the dude character
    player.animations.add('left', [0, 1, 2, 3], 10, true);
    player.animations.add('right', [5, 6, 7, 8], 10, true);


    //  Our controls.
    cursors = game.input.keyboard.createCursorKeys();
    testKeyboard = game.input.keyboard;
    //The timer used to create the meteors sporadically
    //  Create our Timer
    timer = game.time.create(false);

    //  Set a TimerEvent to occur after 2 seconds
    timer.loop(1000, createMeteor, this);

    //  Start the timer running - this is important!
    //  It won't start automatically, allowing you to hook it to button events and the like.
    timer.start();

}

function update() {
    //Updating gravity for each of the meteors.
   meteors.forEachExists(updateGravity, this);
   //Checking for Collisions of meteors
   meteors.forEachExists(checkCollision, this);
   //Check Collisions between meteors and player
   game.physics.arcade.collide(player, meteors);
   //game.physics.arcade.collide(planet, meteors);
    if (cursors.left.isDown)
    {
        // set the player rotation (an offset of a quarter turn since the sprite is facing up)
        player.rotation = rotation;
  
        // from the center of the canvas
        // set the proper coordinates for the current rotation
        // based on the radius + half the player's larger side (since we moved the anchor to 0.5)
        player.x = game.world.centerX +  Math.cos( rotation + (3*Math.PI)/2) * ( planet.width/2 + player.height / 2 );
        player.y = game.world.centerY + Math.sin( rotation + (3*Math.PI)/2) * ( (planet.height/2) + player.height / 2 ); 
  
        // increment rotation
        rotation -= rotationSpeed;

        //Animation or player moving left
        player.animations.play('left');
    }
    else if (cursors.right.isDown)
    {
        // set the player rotation (an offset of a quarter turn since the sprite is facing up)
        player.rotation = rotation;
  
        // from the center of the canvas
        // set the proper coordinates for the current rotation
        // based on the radius + half the player's larger side (since we moved the anchor to 0.5)
        player.x = game.world.centerX +  Math.cos( rotation + (3*Math.PI)/2) * ( planet.width/2 + player.height / 2 );
        player.y = game.world.centerY + Math.sin( rotation + (3*Math.PI)/2) * ( (planet.height/2) + player.height / 2 ); 
  
        // increment rotation
        rotation += rotationSpeed;
        player.animations.play('right');
    }
    else
    {
        //  Stand still
        player.animations.stop();
        player.frame = 4;
    }

}
function checkCollision(star) {
    var topleftBB = new Phaser.Point(star.x, star.y);
    var toprightBB = new Phaser.Point(star.x + star.width, star.y);
    var bottomleftBB = new Phaser.Point(star.x, star.y + star.height);
    var bottomrightBB = new Phaser.Point(star.x + star.width, star.y + star.height);

    var center_x =planet.x +  planet.width/2;
    var center_y = planet.y + planet.height/2;

    var radius_squared = Math.pow((planet.width/2) ,2);

    var tl_left_term = Math.pow(topleftBB.x - center_x , 2) + Math.pow(topleftBB.y - center_y , 2);
    var tr_left_term = Math.pow(toprightBB.x - center_x , 2) + Math.pow(toprightBB.y - center_y , 2);
    var bl_left_term = Math.pow(bottomleftBB.x - center_x , 2) + Math.pow(bottomleftBB.y - center_y , 2);
    var br_left_term = Math.pow(bottomrightBB.x - center_x , 2) + Math.pow(bottomrightBB.y - center_y , 2);


    if (tl_left_term <= radius_squared ||
        tr_left_term <= radius_squared ||
        bl_left_term <= radius_squared ||
        br_left_term <= radius_squared) {
        star.kill();
    }
}
function updateGravity(star) {
    // Calculate gravity as the normalised vector from the ship to the planet
    star.body.gravity = new Phaser.Point(planet.body.x/2 - star.body.x/2, planet.body.y- star.body.y);
    // Normalize and multiply by actual strength of gravity desired
    star.body.gravity = star.body.gravity.normalize().multiply(100,100);
}
function createMeteor() {
    var quads = new Array();
    var quad1 = new Phaser.Point(game.rnd.integerInRange(0, -500), game.rnd.integerInRange(0, -500));
    var quad2 = new Phaser.Point(game.rnd.integerInRange(0, -500), game.rnd.integerInRange(400, 900));
    var quad3 = new Phaser.Point(game.rnd.integerInRange(500, 900), game.rnd.integerInRange(400, 900));
    var quad4 = new Phaser.Point(game.rnd.integerInRange(500, 900), game.rnd.integerInRange(0, -500));
    quads[0] = quad1;
    quads[1] = quad2;
    quads[2] = quad3;
    quads[3] = quad4;
    var meteorpoint = game.rnd.pick(quads);
    meteors.create(meteorpoint.x, meteorpoint.y, 'star');
}
function render() {
game.debug.body(player);
}
</script>

</body>
</html>